<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Bulanan - DELTA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            overflow: hidden; 
        }
        .navbar-gradient { background: linear-gradient(135deg, #065f46 0%, #10b981 100%); }
        .sidebar-link.active { background-color: #065f46; color: #fff; box-shadow: 0 4px 6px rgba(6, 95, 70, 0.4); }
        .sidebar-container { width: 256px; transition: width 0.3s ease; flex-shrink: 0; }
        .sidebar-container.collapsed { width: 80px; }
        .sidebar-container.collapsed .sidebar-text { display: none; }
        .sidebar-container.collapsed .toggle-button-wrapper .fa-arrow-left { transform: rotate(180deg); }
        .toggle-button-wrapper { position: absolute; right: 0; top: 50%; transform: translateY(-50%) translateX(50%); transition: transform 0.3s ease; z-index: 10; }
        
        .master-data-toggle {
            cursor: pointer;
            padding: 1rem;
            text-align: center;
            border-top: 1px solid #065f46;
            color: #fff;
            font-weight: 600;
        }

        .btn-gradient { background-image: linear-gradient(135deg, #065f46 0%, #10b981 100%); }
        
        .main-content-wrapper { flex-grow: 1; display: flex; flex-direction: column; height: 100%; min-width: 0; position: relative; }
        
        .top-bar-clean { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            padding-bottom: 1rem;
            flex-shrink: 0;
            padding-left: 2rem; 
            padding-right: 2rem;
        }

        .content-area { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 0 2rem 2rem 2rem; 
            height: calc(100vh - 80px);
        }
    </style>
</head>
<body>
    
    <div class="flex h-screen bg-gray-50">
        
        <aside id="sidebar" class="sidebar-container navbar-gradient text-white flex flex-col relative h-full">
            <div class="toggle-button-wrapper">
                <button onclick="toggleSidebar(event)" class="w-8 h-8 flex items-center justify-center p-2 rounded-full navbar-gradient text-white shadow-xl hover:shadow-2xl transition-all duration-300">
                    <i id="toggle-icon" class="fas fa-arrow-left text-sm transition-transform duration-300"></i>
                </button>
            </div>
            <div class="flex items-center space-x-3 p-4 border-b border-green-700/50">
                <div class="flex-shrink-0">
                    <div class="bg-white p-2 rounded-lg border border-gray-200">
                        <i class="fas fa-database w-5 h-5 text-green-600"></i>
                    </div>
                </div>
                <div class="flex flex-col sidebar-text flex-grow">
                    <span class="font-extrabold text-lg tracking-wider leading-tight text-white">DEL<span class="text-yellow-300">TA</span></span>
                    <span class="font-medium text-xs text-green-300 leading-tight">Puskesmas Kuta Makmur</span>
                </div>
            </div>
            <nav class="flex-grow p-4 space-y-2">
                <a href="index.html" class="sidebar-link flex items-center p-3 rounded-xl transition-colors duration-200 hover:bg-green-700">
                    <i class="fas fa-tachometer-alt w-5 h-5 mr-3"></i><span class="sidebar-text">Dashboard Utama</span>
                </a>
                <a href="input_data.html" class="sidebar-link active flex items-center p-3 rounded-xl transition-colors duration-200 hover:bg-green-700">
                    <i class="fas fa-pencil-alt w-5 h-5 mr-3"></i><span class="sidebar-text">Laporan Bulanan</span>
                </a>
                <a href="visualisasi_data.html" class="sidebar-link flex items-center p-3 rounded-xl transition-colors duration-200 hover:bg-green-700">
                    <i class="fas fa-chart-bar w-5 h-5 mr-3"></i><span class="sidebar-text">Visualisasi Data</span>
                </a>
            </nav>

            <a href="admin_master.html" class="master-data-toggle flex items-center justify-center p-3 transition-colors duration-200 hover:bg-green-700">
                <i class="fas fa-cogs w-5 h-5 mr-3"></i><span class="sidebar-text">Master Data (Admin)</span>
            </a>
            
        </aside>

        <div class="main-content-wrapper">
            
            <header class="top-bar-clean">
                <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-pencil-alt text-green-500 mr-3"></i> Laporan Bulanan
                </h1>
                <div></div> 
            </header>

            <main class="content-area">
                
                <div class="max-w-4xl mx-auto space-y-8">
                    
                    <div class="bg-white p-6 rounded-xl shadow-xl border border-gray-100">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Pilih Periode & Jenis Data</h3>
                        <form id="periode-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="periode_tahun" class="block text-sm font-medium text-gray-700">Tahun</label>
                                <select id="periode_tahun" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"></select>
                            </div>
                            <div>
                                <label for="periode_bulan" class="block text-sm font-medium text-gray-700">Bulan</label>
                                <select id="periode_bulan" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"></select>
                            </div>
                            <div>
                                <label for="jenis_data" class="block text-sm font-medium text-gray-700">Jenis Data</label>
                                <select id="jenis_data" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                    <option value="" disabled selected>Pilih Jenis</option>
                                    <option value="desa">Data Berdasarkan Desa</option>
                                    <option value="pemeriksaan">Data Berdasarkan Pemeriksaan</option>
                                </select>
                            </div>
                            <div>
                                <button type="submit" id="btn-check-periode" class="w-full btn-gradient text-white py-2 rounded-lg font-semibold">
                                    <i class="fas fa-search mr-2"></i> Cek Periode
                                </button>
                            </div>
                        </form>
                        <div id="periode-status" class="mt-3 text-sm font-medium"></div>
                    </div>
                    
                    <div id="input-area" class="bg-white p-6 rounded-xl shadow-xl border border-gray-100 hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" id="input-area-title">Input Data Baru</h3>
                        <form id="input-data-form">
                            <div id="data-input-table-container" class="overflow-x-auto my-4">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8/12" id="input-table-header">Nama Master</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-4/12">Jumlah Kasus</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="data-input-body">
                                        <tr><td colspan="2" class="px-4 py-3 text-center text-gray-500">Pilih periode dan jenis data di atas.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button type="submit" id="btn-submit-laporan" class="w-full md:w-auto btn-gradient text-white py-2 px-6 rounded-lg font-semibold">
                                    <i class="fas fa-save mr-2"></i> Simpan Data
                                </button>
                            </div>
                            <div id="form-message" class="mt-3 text-sm font-medium text-center"></div>
                        </form>
                    </div>

                </div>

            </main>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', initializeInputPage);

        let masterDataCache = { desa: [], pemeriksaan: [] };
        let currentLaporanId = null; // Menyimpan ID laporan jika mode edit
        let currentJenisData = null; // Menyimpan jenis data yang sedang aktif

        // =========================================================================
        // LOGIKA SIDEBAR & UTILITY
        // =========================================================================
        function toggleSidebar(event) {
            if (event) event.stopPropagation();
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            const icon = document.getElementById('toggle-icon');
            icon.classList.toggle('fa-arrow-left');
            icon.classList.toggle('fa-arrow-right');
        }

        function initializeInputPage() {
            // Mengisi dropdown Tahun dan Bulan
            populatePeriodSelectors();
            
            // Menambahkan event listener ke form periode
            document.getElementById('periode-form').addEventListener('submit', handleCheckPeriode);
            
            // Menambahkan event listener ke form input data
            document.getElementById('input-data-form').addEventListener('submit', handleSubmitLaporan);

            // Memuat data master dan kemudian check URL parameter
            fetchMasterData().then(() => {
                // Setelah master data dimuat, cek URL untuk mode edit
                checkUrlParametersForEdit();
            });
        }

        function populatePeriodSelectors() {
            const currentYear = new Date().getFullYear();
            const yearSelector = document.getElementById('periode_tahun');
            const monthSelector = document.getElementById('periode_bulan');
            
            // Tahun
            let yearOptions = '<option value="" disabled selected>Pilih Tahun</option>';
            for (let y = currentYear; y >= currentYear - 2; y--) {
                yearOptions += `<option value="${y}">${y}</option>`;
            }
            yearSelector.innerHTML = yearOptions;
            
            // Bulan
            let monthOptions = '<option value="" disabled selected>Pilih Bulan</option>';
            const months = ["", "Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            for (let m = 1; m <= 12; m++) {
                monthOptions += `<option value="${m}">${months[m]}</option>`;
            }
            monthSelector.innerHTML = monthOptions;
        }

        function checkUrlParametersForEdit() {
            const urlParams = new URLSearchParams(window.location.search);
            const tahun = urlParams.get('tahun');
            const bulan = urlParams.get('bulan');
            const jenis = urlParams.get('jenis');

            if (tahun && bulan && jenis) {
                // Isi form dengan parameter dari URL
                document.getElementById('periode_tahun').value = tahun;
                document.getElementById('periode_bulan').value = bulan;
                document.getElementById('jenis_data').value = jenis;

                // Buat event simulasi submit untuk memicu pemuatan data
                const submitEvent = new Event('submit', { cancelable: true });
                document.getElementById('periode-form').dispatchEvent(submitEvent);
            }
        }

        // =========================================================================
        // LOGIKA FETCH MASTER DATA (Caching)
        // =========================================================================
        async function fetchMasterData() {
            try {
                const [desaResponse, pemeriksaanResponse] = await Promise.all([
                    fetch('api.php?action=get_master_data&type=desa'),
                    fetch('api.php?action=get_master_data&type=pemeriksaan')
                ]);
                
                const desaResult = await desaResponse.json();
                const pemeriksaanResult = await pemeriksaanResponse.json();
                
                if (desaResult.success) {
                    masterDataCache.desa = desaResult.data || [];
                }
                if (pemeriksaanResult.success) {
                    masterDataCache.pemeriksaan = pemeriksaanResult.data || [];
                }

            } catch (error) {
                console.error("Gagal memuat data master (cache):", error);
            }
        }

        // =========================================================================
        // LOGIKA CEK PERIODE
        // =========================================================================
        async function handleCheckPeriode(event) {
            // Cek apakah event ini adalah event alami dari tombol atau simulasi
            if (event.preventDefault) event.preventDefault(); 

            const tahun = document.getElementById('periode_tahun').value;
            const bulan = document.getElementById('periode_bulan').value;
            const jenis = document.getElementById('jenis_data').value;
            const statusElement = document.getElementById('periode-status');
            const inputArea = document.getElementById('input-area');
            const inputBody = document.getElementById('data-input-body');
            const btnCheckPeriode = document.getElementById('btn-check-periode');

            if (!tahun || !bulan || !jenis) {
                statusElement.textContent = 'Mohon lengkapi semua pilihan periode.';
                statusElement.className = 'mt-3 text-sm font-medium text-red-500';
                inputArea.classList.add('hidden');
                return;
            }
            
            // UI Feedback
            btnCheckPeriode.disabled = true;
            statusElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memeriksa periode...';
            statusElement.className = 'mt-3 text-sm font-medium text-gray-700';
            inputArea.classList.add('hidden');
            
            currentJenisData = jenis;
            currentLaporanId = null;

            try {
                const url = `api.php?action=get_laporan_by_periode&tahun=${tahun}&bulan=${bulan}&jenis=${jenis}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    // Update status
                    statusElement.textContent = result.message;
                    statusElement.className = 'mt-3 text-sm font-medium text-green-600';

                    // Update UI
                    inputArea.classList.remove('hidden');
                    const isEditMode = result.data_laporan !== null;
                    const masterName = jenis === 'desa' ? 'Desa' : 'Pemeriksaan';
                    
                    document.getElementById('input-area-title').textContent = isEditMode ? `Ubah Data ${masterName}` : `Input Data ${masterName} Baru`;
                    document.getElementById('btn-submit-laporan').innerHTML = isEditMode ? `<i class="fas fa-save mr-2"></i> Ubah Data` : `<i class="fas fa-save mr-2"></i> Simpan Data`;
                    document.getElementById('input-table-header').textContent = `Nama ${masterName}`;

                    if (isEditMode) {
                        currentLaporanId = result.data_laporan.id;
                        renderInputTable(jenis, result.data_laporan.data);
                    } else {
                        renderInputTable(jenis);
                    }
                } else {
                    statusElement.textContent = result.message;
                    statusElement.className = 'mt-3 text-sm font-medium text-red-500';
                    inputArea.classList.add('hidden');
                }

            } catch (error) {
                statusElement.textContent = 'Gagal koneksi ke server API.';
                statusElement.className = 'mt-3 text-sm font-medium text-red-500';
                inputArea.classList.add('hidden');
                console.error('Error checking periode:', error);
            } finally {
                btnCheckPeriode.disabled = false;
                btnCheckPeriode.innerHTML = `<i class="fas fa-search mr-2"></i> Cek Periode`;
            }
        }

        function renderInputTable(jenis, existingData = {}) {
            const data = masterDataCache[jenis];
            const inputBody = document.getElementById('data-input-body');
            inputBody.innerHTML = '';
            
            if (data.length === 0) {
                inputBody.innerHTML = `<tr><td colspan="2" class="px-4 py-3 text-center text-red-500">Data master ${jenis} kosong. Silakan tambahkan di halaman Admin Master.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const key = `data_${item.id}`;
                const value = existingData[key] !== undefined ? existingData[key] : '';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700">${item.name}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        <input type="number" name="${key}" value="${value}" min="0" required 
                               class="w-full max-w-[100px] p-2 border border-gray-300 rounded-lg text-center focus:ring-green-500 focus:border-green-500">
                    </td>
                `;
                inputBody.appendChild(row);
            });
        }
        
        // =========================================================================
        // LOGIKA SUBMIT LAPORAN
        // =========================================================================
        async function handleSubmitLaporan(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const dataKasus = {};

            for (let [key, value] of formData.entries()) {
                if (key.startsWith('data_')) {
                    dataKasus[key] = parseInt(value) || 0; 
                }
            }

            const tahun = document.getElementById('periode_tahun').value;
            const bulan = document.getElementById('periode_bulan').value;
            const jenis = document.getElementById('jenis_data').value;
            const isEdit = currentLaporanId !== null;
            const submitButton = document.getElementById('btn-submit-laporan');
            const formMessage = document.getElementById('form-message');

            let payload = {
                periode_tahun: tahun,
                periode_bulan: bulan,
                jenis_data: jenis,
                data_kasus: dataKasus
            };

            let url, method;

            if (isEdit) {
                url = 'api.php?action=update_laporan';
                method = 'PUT';
                payload.laporan_id = currentLaporanId;
            } else {
                url = 'api.php?action=input_laporan';
                method = 'POST';
            }

            const buttonText = isEdit ? 'Ubah Data' : 'Simpan Data';

            // UI Feedback
            submitButton.disabled = true;
            submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Menyimpan...`;
            formMessage.textContent = '';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.success) {
                    formMessage.textContent = result.message;
                    formMessage.className = 'mt-3 text-sm font-medium text-green-600';
                    
                    if (!isEdit) {
                         currentLaporanId = result.laporan_id;
                         document.getElementById('input-area-title').textContent = document.getElementById('input-area-title').textContent.replace('Baru', '(Mode Edit)');
                    }
                    
                } else {
                    formMessage.textContent = result.message;
                    formMessage.className = 'mt-3 text-sm font-medium text-red-500';
                }

            } catch (error) {
                formMessage.textContent = 'Gagal koneksi ke server API.';
                formMessage.className = 'mt-3 text-sm font-medium text-red-500';
                console.error('Error submitting laporan:', error);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `<i class="fas fa-save mr-2"></i> ${buttonText}`;
            }
        }
    </script>
</body>
</html>